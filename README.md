# AiLiberary

pull test
测试
摘要

​	本文结合了当下大模型技术实现了对大模型对图书馆场景的系统开发，集成了一个可服务与图书馆内的问答机器人，并且实现了图书馆场景的功能实现。

​	本文设计的图书问答系统开发模块共分为数据生成及处理模块、大模型部署及微调模块、系统前端开发模块、系统中间件开发模块、系统后端开发模块共五个模块。数据生成及处理模块，接入了deepseekV3大模型设置了较为完善的提示词，以及适配场景式的多随机性问答数据生成，并且通过语义大模型对数据进行清洗，获得了重复性提问低，生成质量高的问答数据，足够进行模型的微调使用。大模型部署及微调模块，实现了在2张A800计算卡的虚拟化环境中对DeepSeek-r1-Distill-Llama-8B模型进行微调的环境部署、模型微调、微调过程监控、模型合并及测试的流程全过程实现。



# ***系统流程框架***

​	大模型助理响应流程

​	前端输入内容请求-> 后端转发请求至FastApi接口 -> FastApi接口调用模型进行回复 -> 后端接受回复内容并进行json解析，提取涉及到的书名内容 -> 对MySql数据库进行查询 -> 返回数据至后端进行数据拼接 -> 返回前端显示  



```bash
uvicorn main:app --host 0.0.0.0 --port 8000 --workers 2
```





### 微调数据样例（JSONL格式）

```json
{"messages": [
  {"role": "user", "content": "推荐类似《白夜行》的书籍"},
  {"role": "assistant", "content": "建议阅读《幻夜》（东野圭吾）和《绝叫》（叶真中显），这些作品都深刻探讨了人性复杂面。借阅期限60天，逾期每天扣5积分"}
]}

{"messages": [
  {"role": "user", "content": "想看推理小说，有什么推荐吗？"},
  {"role": "assistant", "content": "推荐《嫌疑人X的献身》（东野圭吾）和《ABC谋杀案》（阿加莎）。按时还书每册+1积分"}
]}

{"messages": [
  {"role": "user", "content": "如何快速获得读者积分？"},
  {"role": "assistant", "content": "可通过：1）借阅图书（+2分/册）2）提交300字书评（+15分）3）参加读书会（+10分）[1,4](@ref)"}
]}
```





prompt_template = """生成图书馆服务对话需包含以下要素：
[基础要求]
1. 用户提问需涉及以下至少一个场景：
   - 图书推荐（需包含3-5本相关书籍）
   - 积分规则咨询（加分/减分机制）
   - 违规处理咨询（逾期、损坏等）
   - 资源预约（座位/储物柜）

[积分规则嵌入]

2. 根据对话场景自动匹配以下条款（使用[数字]引用对应条款）：
   • 加分机会：
   
     - 借阅图书 [条款1.1]
   
     - 提交300字书评 [条款1.3]
   
     - 参加活动 [条款1.4]
   
     • 扣分风险：
   
     - 逾期 [条款2.1]
   
     - 污损图书 [条款2.2]
   
     - 占座违约[条款2.4]

[**外借及归还**规则嵌入]

​	第三条 外借

1．读者须持本人校园卡到图书馆在服务台或自助借还书机办理图书出借手续。不得代借或转借，因代借或转借而造成的后果由校园卡所有人负责。

2．全校教职工、全日制研究生、全日制本/专科生每人均可同时外借30册图书，外借期限为60天。

3．读者外借图书时应当场检查，如发现污损等情况，应及时请工作人员记录处理，以分清责任。读者对所借图书应妥加爱护保管，如有污损、缺页、遗失等情况，按规定赔偿。

4．图书馆特藏图书、外文图书仅供阅览，不予外借。

第四条 归还和续借

1．读者外借图书应按期归还，可在自助借还书机或服务台办理归还手续。

2．图书逾期前如需继续使用，可办理续借手续，可续借 2 次，逾期的图书不得续借。续借手续可自行在网上或自助借还机办理，也可持校园卡到服务台办理。续借周期和原外借周期相同，从续借之日起计算。

3．借出图书到期日如为法定节假日、寒暑假期间及因特殊情况闭馆期间的，则借期顺延至假期结束或开馆之后。

4．读者离校前，应还清全部所借图书。学生毕业离校的，还清图书后才能通过离校审核。持人事部门所发的离校单读者，还清图书后才能到图书馆服务台办理盖章手续。

第五条 催还 

借出图书到期前 3 天和逾期后，图书馆通过短信或微信发送催还通知，读者收到催还通知后应尽快归还所借图书。

[生成规范]

3. 回复需满足：
   - 规则提醒采用自然语言融入对话
   - 每个提醒最多包含2个相关条款
   - 使用emoji分隔主内容和提醒（📚表示书籍推荐，⚠️表示风险提示）
   - 引用格式：[条款编号](@ref)

示例：
{"messages": [
  {"role": "user", "content": "推荐类似《白夜行》的书籍"},
  {"role": "assistant", "content": "如果您喜欢《白夜行》这样的小说，那么您可能会对以下几部作品感兴趣。这些书籍不仅在情节上引人入胜，而且在人物心理刻画和社会问题探讨方面也有着深刻的表现。

### 东野圭吾的作品

#### 1. 《嫌疑人X的献身》

这部作品是东野圭吾另一部备受赞誉的小说，获得了直木奖。虽然情节与《白夜行》有所不同，但其推理过程非常精巧，结果令人意想不到却又合情合理。故事讲述了一位数学天才为了保护他的邻居而精心策划的一系列事件，展现了人性中的爱与牺牲。

#### 2. 《幻夜》

作为《白夜行》的精神续作，《幻夜》同样聚焦于主角的心理状态以及他们如何面对生活中的困境。尽管有读者认为《幻夜》不如《白夜行》那样出色，但它依然是一个值得探索的故事。书中延续了东野圭吾对于人性复杂性的探讨，尤其是当人们处于极端情况下的选择和行为。

#### 3. 《恶意》

这本书经常被拿来与《白夜行》和《嫌疑人X的献身》相提并论，尽管它可能没有前两者那么震撼人心。然而，《恶意》深入挖掘了人类内心深处的黑暗面——嫉妒与仇恨，并通过一起谋杀案揭示出来。这种对动机的剖析使得整个故事充满了张力。

全校教职工、全日制研究生、全日制本/专科生每人均可同时外借30册图书，外借期限为60天。)"}
]}

{"messages": [
  {"role": "user", "content": "想看推理小说，有什么推荐吗？"},
  {"role": "assistant", "content": "推理小说是一个广受欢迎的文学类型，有许多经典和现代的作品值得一读。以下是一些不同风格和时期的推理小说推荐：

### 经典推理小说
1. **《福尔摩斯探案集》** - 阿瑟·柯南·道尔
   - 这是推理小说的经典之作，讲述了侦探夏洛克·福尔摩斯和他的助手华生医生解决各种复杂案件的故事。

2. **《东方快车谋杀案》** - 阿加莎·克里斯蒂
   - 阿加莎·克里斯蒂是推理小说女王，这本书是她最著名的作品之一，讲述了在东方快车上发生的一起谋杀案，侦探赫尔克里·波洛负责调查。

3. **《无人生还》** - 阿加莎·克里斯蒂
   - 另一部克里斯蒂的经典作品，讲述了一群人被邀请到一个孤岛上，随后接连发生命案的故事。

### 现代推理小说
1. **《龙纹身的女孩》** - 斯蒂格·拉森
   - 这是“千禧年三部曲”的第一部，讲述了记者米卡尔·布洛姆克维斯特和黑客莉丝贝特·萨兰德一起调查一起陈年旧案的故事。

2. **《消失的爱人》** - 吉莉安·弗琳
   - 这本书讲述了一对夫妻的婚姻生活，妻子突然失踪，丈夫成为主要嫌疑人，但随着调查的深入，真相逐渐浮出水面。

3. **《达·芬奇密码》** - 丹·布朗
   - 这本书结合了历史、艺术和宗教元素，讲述了符号学家罗伯特·兰登和密码学家索菲·奈芙一起解开一个古老秘密的故事。

### 日本推理小说
1. **《嫌疑人X的献身》** - 东野圭吾
   - 这是东野圭吾的代表作之一，讲述了数学天才石神哲哉为了保护邻居母女而精心策划的一起谋杀案。

2. **《白夜行》** - 东野圭吾
   - 这本书讲述了一对男女从童年到成年的复杂关系，以及他们之间隐藏的黑暗秘密。

3. **《砂之器》** - 松本清张
   - 这是松本清张的代表作之一，讲述了一起谋杀案背后隐藏的复杂社会问题和人性探讨。

### 其他推荐
1. **《玫瑰的名字》** - 翁贝托·埃科
   - 这本书结合了历史、哲学和推理元素，讲述了中世纪修道院中发生的一系列神秘死亡事件。

2. **《八百万种死法》** - 劳伦斯·布洛克
   - 这是马修·斯卡德系列的第一部，讲述了私家侦探马修·斯卡德调查一起连环杀人案的故事。

3. **《漫长的告别》** - 雷蒙德·钱德勒
   - 这是菲利普·马洛系列的一部经典作品，讲述了私家侦探菲利普·马洛调查一起复杂案件的故事。

这些推理小说各具特色，适合不同口味的读者。希望你能找到自己喜欢的作品，享受阅读的乐趣！按时还书每册+1积分[1,7](@ref)"}
]}

{"messages": [
  {"role": "user", "content": "如何快速获得读者积分？"},
  {"role": "assistant", "content": "可通过：1）借阅图书 2）提交300字书评（3）参加读书会 1,4](@ref)"}
]}

# 模型部分

根据您提供的技术内容和参考结构，以下是重新组织的技术概述目录框架：

------

### **2 相关原理与技术概述**

**2.1 流式数据处理架构**
2.1.1 全链路流式传输（SSE协议）
2.1.2 分阶段数据分块技术
2.1.3 流式数据校验与恢复机制（CRC32 + X-Stream-ID）

**2.2 模块化系统设计**
2.2.1 分层架构（前端/业务/模型/数据层）
2.2.2 前后端交互技术概述（Vue3 + Spring Boot）

**2.3 自然语言处理技术**
2.3.1 模型微调概述
2.3.2 生成式数据
2.3.3 FastApi部署

**2.4 前端流式交互技术**
2.4.1 渐进式渲染（SSE + Vue响应式绑定）
2.4.2 用户体验优化（打字机效果、异步加载）
2.4.3 实时数据关联（IntersectionObserver）

**2.5 高并发后端技术**
2.5.1 响应式非阻塞IO（Spring WebFlux）
2.5.2 流量控制策略（背压机制 + 滑动窗口重传）
2.5.3 热点数据缓存优化（Redis + MySQL适配）

**2.6 本章小结**

```markdown
3.2 领域对话数据生成与清洗  
   3.2.1 基于动态模板的多轮对话生成  
     - 系统提示词与用户提问模板设计  
     - 追问逻辑与领域参数池构建  
   3.2.2 数据验证与质量控制  
     - 正则表达式校验规则  
     - 对话完整性元数据分析  
   3.2.3 数据清洗流程  
     - 重复对话过滤（基于`metadata.validation`）  
     - 无效规则条目剔除  
4.2 轻量化微调实现  
   4.2.1 基于4bit QLoRA的高效训练  
     - 动态序列长度扩展策略  
     - 混合精度与8bit优化器配置  
   4.2.2 参数高效微调设计  
     - 多模块LoRA适配方案  
     - 梯度检查点显存优化  
   4.2.3 训练稳定性增强  
     - 学习率调度与权重衰减  
     - 梯度裁剪策略  
5.3 训练过程监控  
    5.3.1 损失曲线平滑分析  
    5.3.2 显存与吞吐量优化效果  
6. 模型部署与性能优化  
   6.1 轻量化推理服务架构  
     6.1.1 基于FastAPI的RESTful接口设计  
     6.1.2 异常处理与日志监控体系  
   6.2 推理性能优化策略  
     6.2.1 设备自适应加载机制  
     6.2.2 动态生成长度控制  
   6.3 生产环境安全保障  
     6.3.1 输入净化与防御性编程  
     6.3.2 负载测试与吞吐量优化  
     
7. 系统实现与工程实践  
   7.1 系统架构设计  
     7.1.1 分层架构与模块职责  
     7.1.2 核心数据流与状态管理  
   7.2 关键技术实现  
     7.2.1 书名提取与数据融合算法  
     7.2.2 高并发下的服务降级策略  
   7.3 系统性能评估  
     7.3.1 端到端响应时间分析  
     7.3.2 负载测试与水平扩展方案  
```

#### **4. 图书馆智能服务系统实现**

**4.1 模块化架构设计**
4.1.1 ​**分层模块定义与交互逻辑**
\- ​**前端交互模块（Vue3）​**：用户输入采集、流式响应渲染
\- ​**核心业务模块（Spring Boot）​**：流式数据路由、动态提示词增强
\- ​**模型服务模块（FastAPI）​**：流式推理接口、实时结果生成
\- ​**数据服务模块（MySQL+Redis）​**：流式查询适配、热点数据缓存
4.1.2 ​**流式数据流设计**
\- ​**全链路流式传输**：基于SSE（Server-Sent Events）的请求-响应管道
\- ​**分阶段数据分块**：模型推理结果→书名检索→动态拼接→渐进式返回
`mermaid graph LR A[用户输入] --> B(前端分块编码) B --> C{业务模块路由} C -->|流式转发| D[模型推理] D -->|逐块返回| C C -->|实时触发| E[数据检索] E -->|异步填充| C C --> F[前端分块渲染]`

------

**4.2 对话模型核心模块实现**
4.2.1 ​**流式数据生成与适配**
\- ​**模型推理流式化**：FastAPI响应分块（`yield`生成器）
`python @app.post("/stream_generate") async def stream_generate(request: ModelRequest): for chunk in model.stream_generate(**inputs): yield json.dumps({"text": chunk})`
\- ​**业务模块透传优化**：Spring Boot的`ResponseBodyEmitter`流式桥接
4.2.2 ​**流式数据质量保障**
\- ​**分块校验机制**：每块数据完整性校验（CRC32）
\- ​**错误恢复策略**：断点续传标识（`X-Stream-ID`）

------

**4.3 前端流式交互模块实现**
4.3.1 ​**渐进式渲染技术**
\- ​**SSE客户端适配**：`EventSource` API + Vue响应式绑定
\- ​**动态内容拼接**：
`javascript const es = new EventSource("/api/stream"); es.onmessage = (e) => { this.responseText += JSON.parse(e.data).chunk; this.$nextTick(() => this.scrollToBottom()); };`
4.3.2 ​**用户体验优化**
\- ​**打字机效果**：CSS动画模拟逐字输出
\- ​**实时数据关联**：书名高亮与异步详情加载（`IntersectionObserver`）

------

**4.4 后端流式处理模块实现**
4.4.1 ​**流式请求路由**
\- ​**Spring WebFlux适配**：响应式非阻塞IO模型
\- ​**优先级队列管理**：流式请求的权重调度（VIP用户优先）
4.4.2 ​**流式数据融合**
\- ​**并行处理引擎**：模型推理与数据检索并发执行
`java // 模型流式结果与数据库查询并行 Flux<String> modelStream = modelService.streamGenerate(prompt); Flux<Book> bookQuery = bookRepository.findByTitleStream(titles); return Flux.zip(modelStream, bookQuery) .map(tuple -> mergeChunk(tuple.getT1(), tuple.getT2()));`
4.4.3 ​**流量控制策略**
\- ​**背压（Backpressure）机制**：动态调节数据块速率
\- ​**失败重试规则**：基于滑动窗口的丢包重传







------


# 后端开发部分

## 一、WebFlux 简介

### 1.1 Spring MVC 和 Spring WebFlux 的区别？

Spring MVC 和 Spring WebFlux 都是Spring框架中用于构建Web应用程序的模块，它们之间的主要区别在于它们处理并发请求的方式和所采用的编程模型。

1、编程模型：

Spring MVC： 采用同步的、阻塞的编程模型。每个请求都会在一个单独的线程中处理，线程会一直阻塞直到请求完成。
Spring WebFlux： 采用异步的、非阻塞的编程模型。它基于Reactive Streams标准，使用反应式编程的理念，可以更有效地处理大量并发请求，减少线程资源的浪费。
2、并发处理：

Spring MVC： 使用Servlet API中的阻塞IO来处理请求，每个请求需要一个独立的线程，如果线程池中的线程用尽，新的请求就会被阻塞。
Spring WebFlux： 使用非阻塞IO，通过少量的线程处理大量的并发请求。这可以提高系统的吞吐量，因为不需要为每个请求分配一个独立的线程。
3、适用场景：

Spring MVC： 适用于传统的同步IO的应用场景，特别是那些对实时性要求不是很高的场景。
Spring WebFlux： 适用于需要处理大量并发请求、对实时性要求高的场景，比如实时通信、实时数据推送等。
总的来说，如果需要处理大量并发请求，并且对实时性有较高要求，可以选择Spring WebFlux

### 1.3 WebFlux 之 Reactor 框架

在Spring WebFlux中，Reactor是一种基于响应式编程的框架，用于处理异步数据流。Reactor实际上是一个库，它提供了一组用于处理反应式流的API和工具。Spring WebFlux通过Reactor来实现响应式的Web编程模型。

以下是Reactor的一些关键概念：

1、Flux（流）： Flux是Reactor中表示包含零个或多个元素的异步序列的主要类型。它可以发出零到N个元素，并且可以是无限的。在WebFlux中，Flux通常用于表示请求和响应的数据流。
